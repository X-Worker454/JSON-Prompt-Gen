(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const d of r)if(d.type==="childList")for(const p of d.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&s(p)}).observe(document,{childList:!0,subtree:!0});function i(r){const d={};return r.integrity&&(d.integrity=r.integrity),r.referrerPolicy&&(d.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?d.credentials="include":r.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function s(r){if(r.ep)return;r.ep=!0;const d=i(r);fetch(r.href,d)}})();const wt={ALGORITHM:"AES-GCM",KEY_LENGTH:256,IV_LENGTH:12,SALT_LENGTH:16,ITERATIONS:1e5,async deriveKey(v,e){const i=new TextEncoder,s=await crypto.subtle.importKey("raw",i.encode(v),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:e,iterations:this.ITERATIONS,hash:"SHA-256"},s,{name:this.ALGORITHM,length:this.KEY_LENGTH},!1,["encrypt","decrypt"])},async encrypt(v,e){const i=new TextEncoder,s=crypto.getRandomValues(new Uint8Array(this.SALT_LENGTH)),r=crypto.getRandomValues(new Uint8Array(this.IV_LENGTH)),d=await this.deriveKey(e,s),p=await crypto.subtle.encrypt({name:this.ALGORITHM,iv:r},d,i.encode(v)),g=new Uint8Array(s.length+r.length+p.byteLength);return g.set(s,0),g.set(r,s.length),g.set(new Uint8Array(p),s.length+r.length),this.arrayBufferToBase64(g)},async decrypt(v,e){const i=new TextDecoder,s=this.base64ToArrayBuffer(v),r=s.slice(0,this.SALT_LENGTH),d=s.slice(this.SALT_LENGTH,this.SALT_LENGTH+this.IV_LENGTH),p=s.slice(this.SALT_LENGTH+this.IV_LENGTH),g=await this.deriveKey(e,r);try{const w=await crypto.subtle.decrypt({name:this.ALGORITHM,iv:d},g,p);return i.decode(w)}catch{throw new Error("Decryption failed. Invalid password or corrupted data.")}},async getDeviceFingerprint(){var v;try{const i=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,new Date().getTimezoneOffset().toString(),((v=navigator.hardwareConcurrency)==null?void 0:v.toString())||"unknown"].join("|"),s=new TextEncoder,r=await crypto.subtle.digest("SHA-256",s.encode(i));return this.arrayBufferToBase64(new Uint8Array(r))}catch{return"default_device_salt_"+window.location.origin}},arrayBufferToBase64(v){let e="";const i=new Uint8Array(v);for(let s=0;s<i.byteLength;s++)e+=String.fromCharCode(i[s]);return btoa(e)},base64ToArrayBuffer(v){const e=atob(v),i=new Uint8Array(e.length);for(let s=0;s<e.length;s++)i[s]=e.charCodeAt(s);return i}};class bt{constructor(){this.data=null,this.categories=[],this.userCategories=[],this.isInitialized=!1,this.USER_DATA_KEY="user_cinematic_terms"}async init(){if(!this.isInitialized)return this.loadingPromise?this.loadingPromise:(this.loadingPromise=(async()=>{try{const e=await fetch("src/data/dictionary.json");if(!e.ok)throw new Error("Failed to load dictionary data");this.data=await e.json(),this.categories=[...this.data.categories],this.loadUserData(),this.isInitialized=!0,this.loadingPromise=null}catch(e){throw console.error("DictionaryService Error:",e),this.loadingPromise=null,e}})(),this.loadingPromise)}loadUserData(){try{const e=localStorage.getItem(this.USER_DATA_KEY);if(e){const i=JSON.parse(e);this.userCategories=i.categories||[],this.userCategories.forEach(s=>{const r=this.categories.find(d=>d.id===s.id);r?s.terms.forEach(d=>{r.terms.find(p=>p.id===d.id)||r.terms.push(d)}):this.categories.push(s)})}}catch(e){console.error("Error loading user data:",e)}}saveUserData(){try{localStorage.setItem(this.USER_DATA_KEY,JSON.stringify({categories:this.userCategories}))}catch(e){console.error("Error saving user data:",e)}}getAllCategories(){return this.categories}getTermsByCategory(e){const i=this.categories.find(s=>s.id===e);return i?i.terms:[]}searchTerm(e){if(!e||!this.isInitialized)return[];const i=e.toLowerCase().trim(),s=[];return this.categories.forEach(r=>{const d=r.terms.filter(p=>p.name.toLowerCase().includes(i)||p.definition.toLowerCase().includes(i));d.length>0&&s.push({categoryName:r.name,categoryId:r.id,terms:d})}),s}addCategory(e){if(this.categories.find(r=>r.id===e.id))return console.warn("Category already exists:",e.id),!1;const s={id:e.id,name:e.name,author:e.author||"Anonymous",terms:e.terms||[]};return this.categories.push(s),this.userCategories.push(s),this.saveUserData(),!0}addTerm(e,i){const s=this.categories.find(p=>p.id===e);if(!s)return console.error("Category not found:",e),!1;const r={id:i.id||"user_"+Date.now(),name:i.name,definition:i.definition,difficulty:i.difficulty||"beginner",examples:i.examples||[],author:i.author||"Anonymous",likes:i.likes||0};s.terms.push(r);let d=this.userCategories.find(p=>p.id===e);return d||(d={id:e,name:s.name,terms:[]},this.userCategories.push(d)),d.terms!==s.terms&&d.terms.push(r),this.saveUserData(),!0}deleteTerm(e,i){const s=this.categories.find(d=>d.id===e);if(!s)return!1;const r=s.terms.findIndex(d=>d.id===i);if(r>-1){s.terms.splice(r,1);const d=this.userCategories.find(p=>p.id===e);if(d){const p=d.terms.findIndex(g=>g.id===i);p>-1&&d.terms.splice(p,1)}return this.saveUserData(),!0}return!1}editTerm(e,i,s){const r=this.categories.find(g=>g.id===e);if(!r)return!1;const d=r.terms.find(g=>g.id===i);if(!d)return!1;Object.assign(d,{name:s.name||d.name,definition:s.definition||d.definition,difficulty:s.difficulty||d.difficulty,examples:s.examples||d.examples,author:s.author||d.author});const p=this.userCategories.find(g=>g.id===e);if(p){const g=p.terms.find(w=>w.id===i);g&&Object.assign(g,{name:s.name||g.name,definition:s.definition||g.definition,difficulty:s.difficulty||g.difficulty,examples:s.examples||g.examples,author:s.author||g.author})}return this.saveUserData(),!0}deleteCategory(e){const i=this.userCategories.findIndex(r=>r.id===e&&e.startsWith("user_"));if(i===-1)return console.warn("Cannot delete system category:",e),!1;const s=this.categories.findIndex(r=>r.id===e);return s>-1&&this.categories.splice(s,1),this.userCategories.splice(i,1),this.saveUserData(),!0}getTermById(e){for(const i of this.categories){const s=i.terms.find(r=>r.id===e);if(s)return{term:s,categoryId:i.id}}return null}isUserCreated(e){return e&&e.startsWith("user_")}isCategoryUserCreated(e){return e&&e.startsWith("user_")}}class Et{constructor(){this.STORAGE_KEY="llm_vault",this.providers={openai:{name:"OpenAI",models:[{id:"gpt-5.2-pro",name:"GPT-5.2 Pro (Recommended)",maxTokens:4096},{id:"o4-mini",name:"o4-mini",maxTokens:4096},{id:"gpt-4.1-mini",name:"GPT-4.1 mini",maxTokens:4096},{id:"gpt-4.5",name:"GPT-4.5",maxTokens:4096}],endpoint:"https://api.openai.com/v1/chat/completions",validateEndpoint:"https://api.openai.com/v1/models"},anthropic:{name:"Anthropic",models:[{id:"claude-opus-4.5",name:"Claude Opus 4.5 (Recommended)",maxTokens:4096},{id:"claude-sonnet-4.5",name:"Claude Sonnet 4.5",maxTokens:4096},{id:"claude-opus-4.1",name:"Claude Opus 4.1",maxTokens:4096},{id:"claude-haiku-4.5",name:"Claude Haiku 4.5",maxTokens:4096}],endpoint:"https://api.anthropic.com/v1/messages"},gemini:{name:"Gemini",models:[{id:"gemini-3-pro",name:"Gemini 3 Pro (Recommended)",maxTokens:8192},{id:"gemini-2.5-pro",name:"Gemini 2.5 Pro",maxTokens:8192},{id:"gemini-3-flash",name:"Gemini 3 Flash",maxTokens:8192},{id:"gemini-2.5-flash-lite",name:"Gemini 2.5 Flash-Lite",maxTokens:8192}],endpoint:"https://generativelanguage.googleapis.com/v1beta/models"}},this.activeProvider=null,this.config={}}async init(){await this.loadConfig()}async loadConfig(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const i=await CryptoUtils.getDeviceFingerprint(),s=await CryptoUtils.decrypt(e,i);this.config=JSON.parse(s)}}catch(e){console.warn("LLMService: Could not load config, starting fresh.",e.message),this.config={}}}async saveConfig(){try{const e=await CryptoUtils.getDeviceFingerprint(),i=await CryptoUtils.encrypt(JSON.stringify(this.config),e);localStorage.setItem(this.STORAGE_KEY,i)}catch(e){console.error("LLMService: Failed to save config.",e)}}async setProviderKey(e,i,s){if(!this.providers[e])throw new Error(`Unknown provider: ${e}`);this.config[e]={key:i,model:s||this.providers[e].models[0].id,lastUsed:null,requestCount:0},await this.saveConfig()}getProviderKey(e){var i;return((i=this.config[e])==null?void 0:i.key)||null}async removeProvider(e){delete this.config[e],await this.saveConfig()}getConfiguredProviders(){return Object.keys(this.config).filter(e=>{var i;return(i=this.config[e])==null?void 0:i.key})}async validateKey(e,i){try{switch(e){case"openai":return await this._validateOpenAI(i);case"anthropic":return await this._validateAnthropic(i);case"gemini":return await this._validateGemini(i);default:return{valid:!1,message:"Unknown provider"}}}catch(s){return{valid:!1,message:s.message}}}async _validateOpenAI(e){var r;const i=await fetch(this.providers.openai.validateEndpoint,{method:"GET",headers:{Authorization:`Bearer ${e}`}});return i.ok?{valid:!0,message:"API key is valid!"}:{valid:!1,message:((r=(await i.json()).error)==null?void 0:r.message)||"Invalid API key"}}async _validateAnthropic(e){var r;const i=await fetch(this.providers.anthropic.endpoint,{method:"POST",headers:{"x-api-key":e,"anthropic-version":"2023-06-01","content-type":"application/json","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:"claude-3-5-haiku-20241022",max_tokens:10,messages:[{role:"user",content:"Hi"}]})});return i.ok?{valid:!0,message:"API key is valid!"}:{valid:!1,message:((r=(await i.json()).error)==null?void 0:r.message)||"Invalid API key"}}async _validateGemini(e){var d;const i=`${this.providers.gemini.endpoint}?key=${e}`,s=await fetch(i);return s.ok?{valid:!0,message:"API key is valid!"}:{valid:!1,message:((d=(await s.json()).error)==null?void 0:d.message)||"Invalid API key"}}async generatePrompt(e,i,s={}){const r=this.config[e];if(!(r!=null&&r.key))throw new Error(`No API key configured for ${e}`);const d=this._buildSystemPrompt(s.modelProfile||null),p=this._buildUserPrompt(i);let g;switch(e){case"openai":g=await this._callOpenAI(r.key,r.model,d,p,s);break;case"anthropic":g=await this._callAnthropic(r.key,r.model,d,p,s);break;case"gemini":g=await this._callGemini(r.key,r.model,d,p,s);break;default:throw new Error("Unknown provider")}return r.lastUsed=new Date().toISOString(),r.requestCount=(r.requestCount||0)+1,await this.saveConfig(),this._cleanResponse(g)}_cleanResponse(e){return e?e.replace(/^(Prompt|Enhanced Prompt|Result|Response|Scene \d+|Output|Description):?\s*/i,"").replace(/^["'](.*)["']$/s,"$1").trim():""}async generateFullJson(e,i,s={}){const r=this.config[e];if(!(r!=null&&r.key))throw new Error(`No API key configured for ${e}`);const d=`You are a specialized AI for generating professional VEO video prompts in strict JSON format.
        
Your task is to take the user's rough scene inputs and transform them into a polished, cinematic JSON output.
Follow these rules strictly:
1. Output MUST be a valid JSON array of objects.
2. Each object must follow this schema:
   {
     "description": "Enhanced, detailed cinematic description",
     "camera": "Camera angle/movement (keep original if good, or enhance)",
     "lighting": "Lighting style (keep original if good, or enhance)",
     "negative_prompt": "Negative constraints"
   }
3. Enhance the 'description' field to be vivid, detailed, and use professional filmmaking terminology.
4. Keep the 'negative_prompt' robust but concise.
5. Do NOT add any markdown formatting (like \`\`\`json). Output raw JSON string only.
6. Maintain the exact number of scenes as the input.
7. Output ONLY the raw JSON content without any conversational filler or "Prompt" labels.`,p=`Here is the raw scene data to enhance and format as JSON:
${JSON.stringify(i,null,2)}`;let g;switch(e){case"openai":g=await this._callOpenAI(r.key,r.model,d,p,s);break;case"anthropic":g=await this._callAnthropic(r.key,r.model,d,p,s);break;case"gemini":g=await this._callGemini(r.key,r.model,d,p,s);break;default:throw new Error("Unknown provider")}return r.lastUsed=new Date().toISOString(),r.requestCount=(r.requestCount||0)+1,await this.saveConfig(),g.replace(/^```json\s*/i,"").replace(/\s*```$/,"").trim()}_buildSystemPrompt(e=null){let i=`You are PromptForge AI, an expert cinematic video prompt engineer. Your role is to enhance user scene descriptions into highly detailed, professional video generation prompts.

Guidelines:
- Incorporate specific cinematic techniques (camera angles, movements, lighting styles)
- Use vivid, evocative language that AI video models understand
- Maintain the user's creative intent while adding professional depth
- Keep responses focused and concise (max 200 words per scene)
- Output ONLY the refined descriptive text.
- DO NOT include labels like "Prompt:", "Enhanced:", or "Scene:".
- DO NOT include any introductory or concluding remarks.`;return e&&(i+=`

**Target Model: ${e.name}**
`,i+=`- ${e.description}
`,e.supportsCameraControls||(i+=`- This model does NOT support advanced camera controls. Avoid describing specific camera movements like "tracking shot" or "crane shot".
`),e.supportsNegativePrompt||(i+=`- This model does NOT support negative prompts. If the user mentions things to avoid, try to express constraints positively or rephrase.
`),i+=`- Allowed Frame Rates: ${e.allowedFrameRates.join(", ")} fps.
`,i+=`- Max Resolution: ${e.maxResolution}.
`),i}_buildUserPrompt(e){let i=`Enhance this scene description for AI video generation:

`;return i+=`Description: ${e.description||"A cinematic scene"}
`,e.camera&&(i+=`Camera: ${e.camera}
`),e.lighting&&(i+=`Lighting: ${e.lighting}
`),e.negative_prompt&&(i+=`Avoid: ${e.negative_prompt}
`),i}async _callOpenAI(e,i,s,r,d){var w;const p=await fetch(this.providers.openai.endpoint,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({model:i,messages:[{role:"system",content:s},{role:"user",content:r}],temperature:d.temperature||.7,max_tokens:d.maxTokens||500})});if(!p.ok){const E=await p.json();throw new Error(((w=E.error)==null?void 0:w.message)||"OpenAI API error")}return(await p.json()).choices[0].message.content}async _callAnthropic(e,i,s,r,d){var w;const p=await fetch(this.providers.anthropic.endpoint,{method:"POST",headers:{"x-api-key":e,"anthropic-version":"2023-06-01","content-type":"application/json","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:i,max_tokens:d.maxTokens||500,system:s,messages:[{role:"user",content:r}]})});if(!p.ok){const E=await p.json();throw new Error(((w=E.error)==null?void 0:w.message)||"Anthropic API error")}return(await p.json()).content[0].text}async _callGemini(e,i,s,r,d){var x,_;const p=`${this.providers.gemini.endpoint}/${i}:generateContent?key=${e}`,g=await fetch(p,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{role:"user",parts:[{text:`${s}

${r}`}]}],generationConfig:{temperature:d.temperature||.7,maxOutputTokens:d.maxTokens||500}})});if(!g.ok){const I=await g.json();throw new Error(((x=I.error)==null?void 0:x.message)||"Gemini API error")}const w=await g.json();if(!w.candidates||w.candidates.length===0){const I=((_=w.promptFeedback)==null?void 0:_.blockReason)||"UNKNOWN_REASON";throw new Error(`Gemini blocked the request: ${I}. Please try a slightly different prompt.`)}const E=w.candidates[0];if(!E.content||!E.content.parts||E.content.parts.length===0){const I=E.finishReason||"SAFETY/FILTERING";throw new Error(`Gemini response generation failed: ${I}. The content may have been flagged by safety filters.`)}return E.content.parts[0].text}getUsageStats(){const e={};for(const[i,s]of Object.entries(this.config))s!=null&&s.key&&(e[i]={lastUsed:s.lastUsed,requestCount:s.requestCount||0,model:s.model});return e}}class it{constructor(){this.STORAGE_KEY="json_prompt_gen_history",this.MAX_ITEMS=50}save(e,i="json"){const s=this.getAll(),r={id:Date.now().toString(36)+Math.random().toString(36).substr(2,5),timestamp:Date.now(),mode:i,content:e,summary:this._generateSummary(e)};return s.unshift(r),s.length>this.MAX_ITEMS&&(s.length=this.MAX_ITEMS),this._persist(s),r}getAll(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):[]}catch(e){return console.error("Failed to load history:",e),[]}}getById(e){return this.getAll().find(i=>i.id===e)}clear(){localStorage.removeItem(this.STORAGE_KEY)}delete(e){let i=this.getAll();i=i.filter(s=>s.id!==e),this._persist(i)}getDiff(e,i){const s=JSON.stringify(e,null,2),r=JSON.stringify(i,null,2),d=s.split(`
`),p=r.split(`
`);let g="",w=0,E=0;for(;w<d.length||E<p.length;){const x=d[w],_=p[E];x===_?(g+=`<div class="diff-line">${this._escapeHtml(x||"")}</div>`,w++,E++):(x!==void 0&&(g+=`<div class="diff-line diff-remove">- ${this._escapeHtml(x)}</div>`,w++),_!==void 0&&(g+=`<div class="diff-line diff-add">+ ${this._escapeHtml(_)}</div>`,E++))}return g}_generateSummary(e){const i=e.scenes?e.scenes.length:0,s=e.platform||"Unknown";return`${i} Scene${i!==1?"s":""} • ${s}`}_persist(e){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(i){if(console.error("Failed to save history:",i),e.length>1){const s=e.slice(0,Math.floor(e.length/2));this._persist(s)}}}_escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}}class at{constructor(){this.events=[],this.sessionId=this.generateSessionId(),this.init()}init(){this.trackEvent("session_start")}generateSessionId(){return"sess_"+Math.random().toString(36).substr(2,9)}trackEvent(e,i={}){const s={id:this.generateEventId(),name:e,timestamp:new Date().toISOString(),data:i,sessionId:this.sessionId};this.events.push(s),typeof window.gtag=="function"&&window.gtag("event",e,i)}generateEventId(){return"evt_"+Math.random().toString(36).substr(2,9)}trackGeneration(e,i,s){this.trackEvent("generate_prompt",{scene_count:e,mode:i,platform:s})}trackEnhance(e,i){this.trackEvent("enhance_scene",{char_diff:i-e})}trackError(e,i){this.trackEvent("error",{type:e,message:i})}}class Lt{constructor(e){this.analytics=e}async submitFeedback(e,i,s=null){return await new Promise(r=>setTimeout(r,1e3)),this.analytics&&this.analytics.trackEvent("feedback_submitted",{type:e,length:i.length,has_screenshot:!!s}),{success:!0,id:"fb_"+Date.now()}}}class St{constructor(){this.currentStep=1,this.totalSteps=4,this.modal=document.getElementById("getting-started-modal"),this.closeBtn=document.getElementById("getting-started-close-btn"),this.nextBtn=document.getElementById("getting-started-next"),this.prevBtn=document.getElementById("getting-started-prev"),this.checkbox=document.getElementById("dont-show-again"),this.modal&&this.init()}init(){localStorage.getItem("hasSeenGettingStarted")||setTimeout(()=>this.show(),1e3),this.bindEvents(),window.showGettingStarted=()=>this.show()}show(){this.modal.classList.remove("hidden"),this.currentStep=1,this.updateStep()}hide(){this.modal.classList.add("hidden"),this.checkbox.checked&&localStorage.setItem("hasSeenGettingStarted","true")}updateStep(){document.querySelectorAll(".getting-started-step").forEach(i=>{i.classList.add("hidden")});const e=document.querySelector(`.getting-started-step[data-step="${this.currentStep}"]`);e&&e.classList.remove("hidden"),document.querySelectorAll(".progress-dot").forEach(i=>{const s=parseInt(i.dataset.dot);i.classList.toggle("active",s===this.currentStep)}),this.prevBtn.style.display=this.currentStep===1?"none":"inline-flex",this.nextBtn.textContent=this.currentStep===this.totalSteps?"Get Started":"Next"}next(){this.currentStep<this.totalSteps?(this.currentStep++,this.updateStep()):this.hide()}prev(){this.currentStep>1&&(this.currentStep--,this.updateStep())}bindEvents(){this.closeBtn.addEventListener("click",()=>this.hide()),this.nextBtn.addEventListener("click",()=>this.next()),this.prevBtn.addEventListener("click",()=>this.prev()),document.querySelectorAll(".progress-dot").forEach(e=>{e.addEventListener("click",()=>{this.currentStep=parseInt(e.dataset.dot),this.updateStep()})}),this.modal.addEventListener("click",e=>{e.target===this.modal&&this.hide()})}}class kt{constructor(){this.profiles={veo:{id:"veo",name:"Google Veo",maxResolution:"1080p",allowedResolutions:["1080p"],allowedAspectRatios:["16:9","9:16","1:1","4:3","21:9"],allowedFrameRates:["24","30"],supportsNegativePrompt:!0,supportsCameraControls:!0,maxPromptLength:500,description:"Google's high-fidelity video generation model aimed at cinematic realism."},sora:{id:"sora",name:"OpenAI Sora",maxResolution:"1080p",allowedResolutions:["1080p"],allowedAspectRatios:["16:9","9:16","1:1","4:3","21:9"],allowedFrameRates:["24","30","60"],supportsNegativePrompt:!1,supportsCameraControls:!0,maxPromptLength:300,description:"OpenAI's physics-simulating video model known for complex motion."},runway:{id:"runway",name:"Runway Gen-3 Alpha",maxResolution:"4K",allowedResolutions:["720p","1080p","4K"],allowedAspectRatios:["16:9","9:16","21:9"],allowedFrameRates:["24","30","60"],supportsNegativePrompt:!1,supportsCameraControls:!0,maxPromptLength:500,description:"Runway's latest model with advanced temporal consistency and realistic motion."},luma:{id:"luma",name:"Luma Dream Machine",maxResolution:"1080p",allowedResolutions:["1080p"],allowedAspectRatios:["16:9","9:16","1:1","4:3"],allowedFrameRates:["24","30"],supportsNegativePrompt:!0,supportsCameraControls:!0,maxPromptLength:400,description:"Fast, high-quality video model optimized for creative workflows."},kling:{id:"kling",name:"Kling",maxResolution:"1080p",allowedResolutions:["1080p"],allowedAspectRatios:["16:9","9:16","1:1"],allowedFrameRates:["30"],supportsNegativePrompt:!0,supportsCameraControls:!0,maxPromptLength:600,description:"Emerging high-motion model with strong character consistency."}}}getProfile(e){return this.profiles[e]||null}getCapability(e,i){const s=this.profiles[e];return s?s[i]:null}validateParams(e,i){const s=this.profiles[e];if(!s)return{valid:!0,violations:[]};const r=[];return i.resolution&&!s.allowedResolutions.includes(i.resolution)&&r.push({param:"resolution",message:`Resolution '${i.resolution}' is not supported by ${s.name}. Supported: ${s.allowedResolutions.join(", ")}`,suggested:s.allowedResolutions[0]}),i.aspectRatio&&!s.allowedAspectRatios.includes(i.aspectRatio)&&r.push({param:"aspect_ratio",message:`Aspect Ratio '${i.aspectRatio}' is not supported by ${s.name}. Supported: ${s.allowedAspectRatios.join(", ")}`,suggested:s.allowedAspectRatios[0]}),i.frameRate&&!s.allowedFrameRates.includes(String(i.frameRate))&&r.push({param:"frame_rate",message:`Frame Rate '${i.frameRate}' is not supported by ${s.name}. Supported: ${s.allowedFrameRates.join(", ")}`,suggested:s.allowedFrameRates[0]}),{valid:r.length===0,violations:r}}supports(e,i){const s=this.profiles[e];return s?!!s[i]:!0}validateContent(e){if(!e)return{safe:!0,flagged:[]};const s=["nsfw","naked","graphic violence","blood","hate speech"].filter(r=>e.toLowerCase().includes(r));return{safe:s.length===0,flagged:s}}formatPayload(e,i){var r;const s={target_model:((r=this.profiles[e])==null?void 0:r.name)||e,generated_at:new Date().toISOString(),...i};return e==="sora"?{model:"sora-1.0",prompts:i.scenes.map(d=>d.description),advanced_params:{...i.global_parameters},metadata:s}:s}}class It{constructor(){this.STORAGE_KEY="json_prompt_gen_global_params",this.modelService=new kt,this.defaults={platform_preset:"veo",aspect_ratio:"16:9",resolution:"1080p",frame_rate:"24"},this.params=this.loadState()}loadState(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e)return{...this.defaults,...JSON.parse(e)}}catch(e){console.warn("Failed to load global params:",e)}return{...this.defaults}}saveState(){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.params))}catch(e){console.warn("Failed to save global params:",e)}}getParams(){return{...this.params}}updateParam(e,i){if(this.params.hasOwnProperty(e)){this.params[e]=i;const s=this.params.platform_preset,r=this.modelService.validateParams(s,this.params);return r.valid||(r.violations.forEach(d=>{this.params[d.param]=d.suggested}),window.dispatchEvent(new CustomEvent("global-params-corrected",{detail:{violations:r.violations}}))),this.saveState(),!0}return!1}resetDefaults(){return this.params={...this.defaults},this.saveState(),this.params}}class Ct{constructor(){this.init()}init(){document.querySelectorAll(".btn-pricing.coming-soon").forEach(s=>{s.addEventListener("click",r=>{r.preventDefault();const d=s.closest(".pricing-card"),p=d?d.querySelector(".tier-name").textContent.trim():"Premium Tier";typeof window.showToast=="function"&&window.showToast("Coming Soon!",`You've been added to the notify list for the ${p}.`,"success",4e3);const g=s.textContent;s.textContent="Notified!",s.classList.add("active"),setTimeout(()=>{s.textContent=g,s.classList.remove("active")},3e3)})}),document.querySelectorAll('a[href="#pricing-section"]').forEach(s=>{s.addEventListener("click",r=>{r.preventDefault(),window.switchSection?window.switchSection("pricing-section"):console.warn("Navigation function not available")})})}}window.CryptoUtils=wt;window.AnalyticsService=at;window.historyService=new it;document.addEventListener("DOMContentLoaded",()=>{var Xe,Qe,et,tt,nt,st;new St,new Ct;const v=document.getElementById("scenes-container"),e=document.getElementById("add-scene-btn"),i=document.getElementById("generate-btn"),s=document.getElementById("output-json"),r=document.getElementById("sidebar"),d=document.getElementById("sidebar-overlay"),p=document.getElementById("hamburger-btn"),g=document.getElementById("sidebar-close"),w=document.querySelectorAll(".sidebar-link"),E=document.getElementById("sidebar-reset-btn"),x=document.getElementById("sidebar-export-btn");function _(){r.classList.add("active"),d.classList.add("active"),document.body.style.overflow="hidden"}function I(){r.classList.remove("active"),d.classList.remove("active"),document.body.style.overflow=""}p.addEventListener("click",_),g.addEventListener("click",I),d.addEventListener("click",I),w.forEach(t=>{t.addEventListener("click",n=>{const o=t.dataset.section;o&&(n.preventDefault(),ve(o),I())})}),E&&E.addEventListener("click",t=>{var n;t.preventDefault(),I(),(n=document.getElementById("reset-btn"))==null||n.click()}),x&&x.addEventListener("click",t=>{var n;t.preventDefault(),I(),(n=document.getElementById("download-btn"))==null||n.click()});const ke=new at,rt=new Lt(ke),R=new it,oe=document.getElementById("feedback-modal"),Ie=document.getElementById("sidebar-feedback-btn"),Ce=document.getElementById("feedback-close-btn"),xe=document.getElementById("feedback-cancel-btn"),ie=document.getElementById("feedback-submit-btn"),Te=document.querySelectorAll("#feedback-type-chips .chip");let Be="bug";function Ae(){oe&&(oe.classList.remove("hidden"),ke.trackEvent("feedback_open"),I())}function he(){oe&&oe.classList.add("hidden")}const _e=document.getElementById("footer-feedback-btn");Ie&&Ie.addEventListener("click",Ae),_e&&_e.addEventListener("click",Ae),Ce&&Ce.addEventListener("click",he),xe&&xe.addEventListener("click",he),Te.forEach(t=>{t.addEventListener("click",()=>{Te.forEach(n=>n.classList.remove("active")),t.classList.add("active"),Be=t.dataset.value})}),ie&&ie.addEventListener("click",async()=>{const t=document.getElementById("feedback-message").value;if(!t.trim()){showToast("Error","Please enter a message.","error");return}ie.classList.add("loading");try{await rt.submitFeedback(Be,t),showToast("Feedback Sent","Thank you for your feedback!","success"),document.getElementById("feedback-message").value="",he()}catch{showToast("Error","Failed to send feedback.","error")}finally{ie.classList.remove("loading")}});const k=new It,$=[{key:"aspect_ratio",wrapperId:"global-aspect-ratio-dropdown",inputId:"global-aspect-ratio",displayId:"global-aspect-ratio-display"},{key:"resolution",wrapperId:"global-resolution-dropdown",inputId:"global-resolution",displayId:"global-resolution-display"},{key:"frame_rate",wrapperId:"global-frame-rate-dropdown",inputId:"global-frame-rate",displayId:"global-frame-rate-display"},{key:"platform_preset",wrapperId:"global-platform-dropdown",inputId:"global-platform",displayId:"global-platform-display"}];$.forEach(t=>{const n=document.getElementById(t.wrapperId);if(!n)return;const o=n.querySelector(".dropdown-trigger"),a=n.querySelector(".dropdown-menu"),l=document.getElementById(t.inputId),c=document.getElementById(t.displayId);o.addEventListener("click",m=>{m.stopPropagation(),$.forEach(u=>{var f;u.wrapperId!==t.wrapperId&&((f=document.getElementById(u.wrapperId))==null||f.classList.remove("open"))}),n.classList.toggle("open")}),a.addEventListener("click",m=>{m.stopPropagation();const u=m.target.closest(".dropdown-item");if(u){const f=u.dataset.value,h=u.textContent;c.textContent=h,a.querySelectorAll(".dropdown-item").forEach(y=>y.classList.remove("selected")),u.classList.add("selected"),l.value=f,k.updateParam(t.key,f),re(),n.classList.remove("open")}})}),document.addEventListener("click",()=>{$.forEach(t=>{var n;(n=document.getElementById(t.wrapperId))==null||n.classList.remove("open")})});function ae(){const t=k.getParams(),n=(o,a)=>{const l=document.getElementById(o.wrapperId),c=document.getElementById(o.inputId),m=document.getElementById(o.displayId);if(l&&c&&m){c.value=a;const u=l.querySelector(`.dropdown-item[data-value="${a}"]`);u&&(m.textContent=u.textContent,l.querySelectorAll(".dropdown-item").forEach(f=>f.classList.remove("selected")),u.classList.add("selected"))}};n($[0],t.aspect_ratio),n($[1],t.resolution),n($[2],t.frame_rate),n($[3],t.platform_preset),re()}function re(){const n=k.getParams().platform_preset,o=k.modelService,a=o.supports(n,"supportsNegativePrompt");document.querySelectorAll(".scene-negative-prompt").forEach(c=>{const m=c.closest(".form-group");if(m){const u=m.previousElementSibling;a?(m.classList.remove("hidden"),u&&u.classList.remove("no-separator")):(m.classList.add("hidden"),u&&u.classList.add("no-separator"))}});const l=o.supports(n,"supportsCameraControls");document.querySelectorAll(".scene-camera-value").forEach(c=>{const m=c.closest(".form-group");m&&(l?(m.classList.remove("disabled-group"),m.querySelector(".pills-container").style.pointerEvents="auto",m.style.opacity="1"):(m.classList.add("disabled-group"),m.querySelector(".pills-container").style.pointerEvents="none",m.style.opacity="0.5"))})}window.addEventListener("global-params-corrected",t=>{const o=t.detail.violations.map(a=>`• ${a.message}`).join("<br>");showToast("Settings Adjusted",o,"warning",6e3),ae(),re()}),ae();const Pe=document.getElementById("reset-global-params");Pe&&Pe.addEventListener("click",()=>{confirm("Reset all global parameters to defaults?")&&(k.resetDefaults(),ae(),showToast("Global Parameters Reset","All global settings have been restored to defaults.","info"))});let z=1;e.addEventListener("click",()=>{z++;const t=z,n=`
            <div class="scene-item" data-scene-id="${t}">
                <div class="scene-header">
                    <h4 class="scene-title" style="margin: 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">Scene ${t}</h4>
                    <div class="scene-actions">
                        <button class="scene-undo-btn hidden" title="Undo AI Enhancement">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10h10a5 5 0 0 1 5 5v2"/><path d="m3 10 6 6"/><path d="m3 10 6-6"/></svg>
                        </button>
                        <button class="scene-redo-btn hidden" title="Redo AI Enhancement">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10H11a5 5 0 0 0-5 5v2"/><path d="m21 10-6 6"/><path d="m21 10-6-6"/></svg>
                        </button>
                        <button class="scene-enhance-btn" title="Enhance with AI">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" class="enhance-stars-icon">
                                <path d="M15.5 5.5 L16.8 10.2 L21.5 11.5 L16.8 12.8 L15.5 17.5 L14.2 12.8 L9.5 11.5 L14.2 10.2 Z" />
                                <path d="M5.5 2.5 L6.2 4.8 L8.5 5.5 L6.2 6.2 L5.5 8.5 L4.8 6.2 L2.5 5.5 L4.8 4.8 Z" />
                                <path d="M6.5 15.5 L7.2 17.8 L9.5 18.5 L7.2 19.2 L6.5 21.5 L5.8 19.2 L3.5 18.5 L5.8 17.8 Z" />
                            </svg>
                        </button>
                        <button class="remove-scene-btn" onclick="removeScene(this)" title="Remove Scene">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </div>
                </div>
                <div class="form-group mb-30">
                    <label class="section-label">Scene Description</label>
                    <textarea class="scene-description" placeholder="Describe your scene in detail..." style="min-height: 100px; background: rgba(0,0,0,0.2);"></textarea>
                </div>
                <div class="form-group mb-30">
                    <label class="section-label">Camera Angle</label>
                    <input type="hidden" class="scene-camera-value" value="">
                    <div class="pills-container camera-pills">
                        <button class="pill" data-value="pan_left">Pan Left</button>
                        <button class="pill" data-value="pan_right">Pan Right</button>
                        <button class="pill" data-value="zoom_in">Zoom In</button>
                        <button class="pill" data-value="zoom_out">Zoom Out</button>
                        <button class="pill" data-value="dolly_zoom">Dolly Zoom</button>
                        <button class="pill" data-value="tracking_shot">Track</button>
                        <button class="pill" data-value="eye_level">Eye Level</button>
                        <button class="pill" data-value="low_angle">Low Angle</button>
                        <button class="pill" data-value="high_angle">High Angle</button>
                        <button class="pill" data-value="aerial_view">Aerial View</button>
                    </div>
                </div>
                <div class="form-group mb-30">
                    <label class="section-label">Lighting Style</label>
                    <input type="hidden" class="scene-lighting-value" value="">
                    <div class="pills-container lighting-pills">
                        <button class="pill" data-value="natural">Natural</button>
                        <button class="pill" data-value="golden_hour">Golden Hour</button>
                        <button class="pill" data-value="blue_hour">Blue Hour</button>
                        <button class="pill" data-value="neon">Neon Cyberpunk</button>
                        <button class="pill" data-value="studio">Studio</button>
                        <button class="pill" data-value="dramatic">Dramatic</button>
                        <button class="pill" data-value="cinematic">Cinematic</button>
                        <button class="pill" data-value="softbox">Softbox</button>
                        <button class="pill" data-value="backlit">Backlit</button>
                        <button class="pill" data-value="rim_light">Rim Light</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="section-label">Negative Prompts</label>
                    <div class="pills-container negative-pills mb-12">
                        <button class="pill" data-value="blurry">Blurry</button>
                        <button class="pill" data-value="low_res">Low Res</button>
                        <button class="pill" data-value="deformed">Deformed</button>
                        <button class="pill" data-value="watermark">Watermark</button>
                        <button class="pill" data-value="flicker">Flicker</button>
                        <button class="pill" data-value="grainy">Grainy</button>
                        <button class="pill" data-value="overexposed">Overexposed</button>
                        <button class="pill" data-value="extra_limbs">Extra Limbs</button>
                        <button class="pill" data-value="distorted">Distorted</button>
                        <button class="pill" data-value="unrealistic">Unrealistic</button>
                    </div>
                    <input type="text" class="scene-negative-prompt" placeholder="Or type custom elements to exclude..." style="background: rgba(0,0,0,0.2); margin-bottom: 5px;">
                </div>
            </div>
        `;v.insertAdjacentHTML("beforeend",n),re()}),v.addEventListener("click",t=>{if(t.target.classList.contains("pill")){const n=t.target,o=n.closest(".pills-container");if(o.classList.contains("negative-pills"))n.classList.toggle("active");else{const l=o.previousElementSibling;n.classList.contains("active")?(n.classList.remove("active"),l.value=""):(o.querySelectorAll(".pill").forEach(c=>c.classList.remove("active")),n.classList.add("active"),l.value=n.dataset.value)}}}),window.removeScene=function(t){const n=t.closest(".scene-item");n&&(n.remove(),lt())};function lt(){const t=v.querySelectorAll(".scene-item");t.forEach((n,o)=>{const a=n.querySelector("h4");a&&(a.textContent=`Scene ${o+1}`)}),z=t.length}const qe=document.getElementById("reset-btn");qe&&qe.addEventListener("click",()=>{var t,n;if(confirm("Are you sure you want to reset the generator? All current work will be lost.")){const o=v.querySelector('.scene-item[data-scene-id="1"]');o&&(o.querySelector(".scene-description").value="",o.querySelector(".scene-negative-prompt").value="",o.querySelector(".scene-camera-value").value="",o.querySelector(".scene-lighting-value").value="",o.querySelectorAll(".pill.active").forEach(l=>l.classList.remove("active")),(t=o.querySelector(".scene-undo-btn"))==null||t.classList.add("hidden"),(n=o.querySelector(".scene-redo-btn"))==null||n.classList.add("hidden")),v.querySelectorAll('.scene-item:not([data-scene-id="1"])').forEach(l=>l.remove()),z=1,s.value=JSON.stringify({platform:"veo",prompt:"Waiting for input...",parameters:{aspect_ratio:"16:9",resolution:"1080p"}},null,2),showToast("Generator Reset","All scenes and outputs have been cleared.","info")}}),i.addEventListener("click",async()=>{i.classList.add("loading"),await new Promise(t=>setTimeout(t,600));try{const t=[];if(v.querySelectorAll(".scene-item").forEach(u=>{const f=u.querySelector(".scene-description").value,h=u.querySelector(".scene-camera-value").value,y=u.querySelector(".scene-lighting-value").value,L=Array.from(u.querySelectorAll(".negative-pills .pill.active")).map(Se=>Se.textContent),O=u.querySelector(".scene-negative-prompt").value.trim();let Y=L.join(", ");O&&(Y=Y?`${Y}, ${O}`:O),f.trim()&&t.push({description:f.trim(),negative_prompt:Y||null,parameters:{camera:h||null,lighting:y||null}})}),t.length===0){showToast("Empty Prompt","Please add at least one scene description.","warning");return}const o=k.modelService.validateContent(JSON.stringify(t));if(!o.safe){showToast("Safety Violation",`Content contains prohibited terms: ${o.flagged.join(", ")}`,"error");return}const a=document.querySelector('input[name="gen-mode"]:checked'),l=a?a.value:"json",c=k.getParams(),m={platform:c.platform_preset,version:"1.0",scenes:[],global_parameters:{aspect_ratio:c.aspect_ratio,resolution:c.resolution,frame_rate:c.frame_rate}};if(l==="ai"){const u=S.getConfiguredProviders();if(u.length===0){showToast("Configuration Required","Please configure an AI provider in the integration hub first.","warning");return}const f=u[0];i.disabled=!0;try{const h=await S.generateFullJson(f,t);let y;try{y=JSON.parse(h)}catch{throw new Error("Failed to parse AI response as valid JSON.")}m.scenes=y;const L=k.modelService.formatPayload(c.platform_preset,m);s.value=JSON.stringify(L,null,2),R&&R.save(L,"ai"),showToast("AI Generation Complete","Enhanced JSON prompt generated successfully!","success"),document.getElementById("output-section").classList.remove("hidden"),document.getElementById("output-section").scrollIntoView({behavior:"smooth",block:"start"})}catch(h){console.error("AI Gen Error:",h),showToast("Generation Failed",h.message,"error")}finally{i.disabled=!1}}else{m.scenes=t;const u=k.modelService.formatPayload(c.platform_preset,m);s.value=JSON.stringify(u,null,2),R&&R.save(u,"json"),showToast("Success","JSON generated successfully!","success"),document.getElementById("output-section").classList.remove("hidden"),document.getElementById("output-section").scrollIntoView({behavior:"smooth",block:"start"})}}catch(t){console.error("Generation Error:",t),showToast("Error","An unexpected error occurred.","error")}finally{i.classList.remove("loading")}}),document.getElementById("copy-btn").addEventListener("click",()=>{const t=s.value;if(!t||t.includes("Waiting for input...")){showToast("No Content","Generate a prompt first.","warning");return}navigator.clipboard.writeText(t).then(()=>{showToast("Copied","JSON prompt copied to clipboard!","success")}).catch(n=>{showToast("Error","Failed to copy to clipboard.","error")})}),document.getElementById("download-btn").addEventListener("click",()=>{const t=s.value;if(!t||t.includes("Waiting for input...")){showToast("No Content","Generate a prompt first.","warning");return}const n=new Blob([t],{type:"application/json"}),o=URL.createObjectURL(n),a=document.createElement("a");a.href=o,a.download=`veo-prompt-${Date.now()}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o),showToast("Downloaded","JSON file downloaded successfully.","success")});const b=new bt;document.getElementById("dictionary-section");const ct=document.getElementById("generator-section");document.getElementById("output-section");const H=document.querySelectorAll(".main-nav a"),T=document.getElementById("dict-content"),M=document.getElementById("dict-category-list"),Ne=document.getElementById("dict-search"),W=document.getElementById("dict-active-category-title"),S=new Et,dt=document.getElementById("llm-section"),Oe=document.getElementById("ai-enhance-btn"),le=document.getElementById("llm-key-modal"),Re=document.getElementById("llm-modal-close-btn"),$e=document.getElementById("key-modal-cancel"),Me=document.getElementById("key-modal-save"),fe=document.getElementById("provider-api-key"),G=document.getElementById("key-validation-status"),Ge=document.querySelectorAll(".provider-card"),j=document.querySelector(".usage-dashboard");let ce=null,F=null;S.init().then(()=>{be()});const D=document.getElementById("contribution-modal"),Ue=document.getElementById("dict-contribute-btn"),He=document.getElementById("modal-close-btn"),je=document.getElementById("modal-cancel-btn"),de=document.getElementById("modal-submit-btn");document.getElementById("contrib-category"),document.getElementById("new-category-check");const U=document.getElementById("new-category-name"),K=document.getElementById("contrib-difficulty-pills");let B=null;const ue=document.getElementById("toggle-api-key");ue&&ue.addEventListener("click",()=>{const t=document.getElementById("provider-api-key"),n=ue.querySelector(".eye-icon"),o=ue.querySelector(".eye-off-icon");t.type==="password"?(t.type="text",n.classList.add("hidden"),o.classList.remove("hidden")):(t.type="password",n.classList.remove("hidden"),o.classList.add("hidden"))});function ve(t){var c,m;if(!t)return;document.querySelectorAll(".main-nav a").forEach(u=>{u.dataset.section===t?u.classList.add("active"):u.classList.remove("active")}),document.querySelectorAll(".sidebar-link").forEach(u=>{u.dataset.section===t?u.classList.add("active"):u.classList.remove("active")}),document.querySelectorAll("section").forEach(u=>u.classList.add("hidden"));const n=document.querySelector(".hero-section"),o=document.querySelector(".dict-hero"),a=document.querySelector(".pricing-hero");n==null||n.classList.add("hidden"),o==null||o.classList.add("hidden"),a==null||a.classList.add("hidden");const l=document.getElementById(t);l&&l.classList.remove("hidden"),t==="generator-section"?(n==null||n.classList.remove("hidden"),(c=document.getElementById("global-params-section"))==null||c.classList.remove("hidden"),(m=document.getElementById("output-section"))==null||m.classList.remove("hidden")):t==="dictionary-section"?(o==null||o.classList.remove("hidden"),b.isInitialized||b.init().then(()=>{ye(),we(),setTimeout(()=>{const u=document.querySelector('li[data-cat-id="camera_techniques"]');u&&u.querySelector(".category-name").click()},100)})):t==="llm-section"?be():t==="history-section"?typeof N=="function"&&N("section"):t==="pricing-section"&&(a==null||a.classList.remove("hidden"))}window.switchSection=ve,H.forEach(t=>{t.addEventListener("click",n=>{n.preventDefault();const o=t.dataset.section;ve(o)})});function ye(){if(!M)return;M.innerHTML="",b.getAllCategories().forEach(n=>{const o=document.createElement("li"),a=b.isCategoryUserCreated(n.id);a&&o.classList.add("user-category");const l=document.createElement("span");if(l.textContent=n.name,l.className="category-name",o.appendChild(l),a){const c=document.createElement("button");c.className="category-delete-btn",c.title="Delete Category",c.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                `,c.addEventListener("click",m=>{m.stopPropagation(),ht(n.id)}),o.appendChild(c)}o.dataset.catId=n.id,l.addEventListener("click",()=>{M.querySelectorAll("li").forEach(c=>c.classList.remove("active")),o.classList.add("active"),B=n.id,W.textContent=n.name,Z(n.id)}),M.appendChild(o)})}function Z(t){if(T.innerHTML="",!t){T.innerHTML='<div class="empty-state">Select a category from the sidebar to view terms</div>';return}b.getTermsByCategory(t).forEach(o=>{const a=Fe(o);T.appendChild(a)})}function Fe(t){const n=document.createElement("div"),o=b.isUserCreated(t.id);n.className=`term-card ${o?"user-term":""}`,n.dataset.termId=t.id;const a=t.examples&&t.examples.length>0?`<div class="term-examples">
                <h5>Examples:</h5>
                <ul>${t.examples.map(y=>`<li>${y}</li>`).join("")}</ul>
               </div>`:"",l=t.difficulty||"beginner",c=t.author||"System",m=t.likes||0,u=o?`
            <button class="term-manage-btn edit-btn" data-term-id="${t.id}" title="Edit Term">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
            </button>
            <button class="term-manage-btn delete-btn" data-term-id="${t.id}" title="Delete Term">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            </button>
        `:"";n.innerHTML=`
            <div class="term-header">
                <h4 class="term-title">${t.name}</h4>
                <div class="term-header-right">
                    <span class="difficulty-badge ${l}">${l}</span>
                    ${u}
                </div>
            </div>
            <p class="term-definition">${t.definition}</p>
            ${a}
            <div class="term-footer">
                <div class="term-author">By: <span>@${c}</span></div>
                <div class="term-actions">
                    <button class="term-action-btn like-btn" data-term-id="${t.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        <span class="like-count">${m}</span>
                    </button>
                    <button class="btn-use-prompt" data-term-name="${t.name}">Use in Prompt</button>
                </div>
            </div>
        `;const f=n.querySelector(".like-btn");return f.addEventListener("click",()=>ut(t.id,f)),n.querySelector(".btn-use-prompt").addEventListener("click",()=>mt(t.name)),o&&(n.querySelector(".edit-btn").addEventListener("click",()=>pt(t.id)),n.querySelector(".delete-btn").addEventListener("click",()=>gt(t.id))),n}function ut(t,n){n.classList.toggle("liked");const o=n.querySelector(".like-count");let a=parseInt(o.textContent)||0;n.classList.contains("liked")?a++:a=Math.max(0,a-1),o.textContent=a;const l=JSON.parse(localStorage.getItem("likedTerms")||"[]");if(n.classList.contains("liked"))l.includes(t)||l.push(t);else{const c=l.indexOf(t);c>-1&&l.splice(c,1)}localStorage.setItem("likedTerms",JSON.stringify(l))}function mt(t){var o,a,l;const n=document.querySelector(".scene-description");if(n){const c=n.value;n.value=c?`${c}, ${t}`:t,n.dispatchEvent(new Event("input",{bubbles:!0}));const m=Array.from(H).find(u=>u.textContent.trim()==="JSON Generator");m?m.click():(document.querySelectorAll("section").forEach(u=>u.classList.add("hidden")),ct.classList.remove("hidden"),(o=document.getElementById("global-params-section"))==null||o.classList.remove("hidden"),(a=document.getElementById("output-section"))==null||a.classList.remove("hidden"),(l=document.querySelector(".hero-section"))==null||l.classList.remove("hidden"),H.forEach(u=>u.classList.remove("active")),H[0]&&H[0].classList.add("active")),typeof showToast=="function"&&showToast("Term Applied",`"${t}" added to scene 1`,"success")}else{const c=Array.from(H).find(m=>m.textContent.trim()==="JSON Generator");c&&c.click(),typeof showToast=="function"&&showToast("No Active Scene","Add a scene first to use dictionary terms.","warning")}}let me=null,J=null;function pt(t){const n=b.getTermById(t);if(!n)return;const{term:o,categoryId:a}=n;me=t,J=a,document.getElementById("contrib-username").value=o.author||"",document.getElementById("contrib-term-name").value=o.name||"",document.getElementById("contrib-definition").value=o.definition||"",document.getElementById("contrib-examples").value=o.examples?o.examples.join(", "):"",P=a;const l=b.getAllCategories().find(m=>m.id===a);l&&(pe.textContent=l.name),K.querySelectorAll(".pill").forEach(m=>{m.classList.remove("active"),m.dataset.value===o.difficulty&&m.classList.add("active")}),document.querySelector(".modal-header h3").textContent="Edit Term",de.textContent="Update Term",D.classList.remove("hidden")}function gt(t){if(!confirm("Are you sure you want to delete this term? This action cannot be undone."))return;const n=b.getTermById(t);if(!n)return;const{categoryId:o}=n;b.deleteTerm(o,t)&&B===o&&Z(o)}function ht(t){const n=b.getAllCategories().find(a=>a.id===t),o=n?n.name:"this category";confirm(`Are you sure you want to delete "${o}"? All terms in this category will also be deleted. This action cannot be undone.`)&&b.deleteCategory(t)&&(ye(),we(),B===t&&(B=null,W.textContent="Select a Category",T.innerHTML='<div class="empty-state">Select a category from the sidebar to view terms</div>'))}Ne&&Ne.addEventListener("input",t=>{const n=t.target.value.trim();if(n.length>0){M==null||M.querySelectorAll("li").forEach(a=>a.classList.remove("active")),W.textContent=`Search: "${n}"`;const o=b.searchTerm(n);ft(o)}else if(B){const o=b.getAllCategories().find(a=>a.id===B);W.textContent=o?o.name:"Select a Category",Z(B)}else W.textContent="Select a Category",T.innerHTML='<div class="empty-state">Select a category from the sidebar to view terms</div>'});function ft(t){if(T.innerHTML="",t.length===0){T.innerHTML='<div class="empty-state">No terms found matching your query.</div>';return}t.forEach(n=>{const o=document.createElement("div");o.className="search-category-header",o.textContent=n.categoryName,T.appendChild(o),n.terms.forEach(a=>{const l=Fe(a);T.appendChild(l)})})}Ue&&Ue.addEventListener("click",()=>{Q(),D.classList.remove("hidden")});const X=document.getElementById("custom-category-dropdown"),De=document.getElementById("dropdown-trigger"),C=document.getElementById("dropdown-menu"),pe=document.querySelector(".dropdown-value");let P=null;De&&De.addEventListener("click",t=>{t.stopPropagation(),X.classList.toggle("open"),C.classList.toggle("hidden")}),document.addEventListener("click",t=>{X&&!X.contains(t.target)&&(X.classList.remove("open"),C==null||C.classList.add("hidden"))}),K&&K.addEventListener("click",t=>{t.target.classList.contains("pill")&&(K.querySelectorAll(".pill").forEach(n=>n.classList.remove("active")),t.target.classList.add("active"))});function we(){if(!C)return;C.innerHTML="",b.getAllCategories().forEach(o=>{const a=document.createElement("div");a.className="dropdown-item",a.dataset.categoryId=o.id,a.textContent=o.name,o.id===P&&a.classList.add("selected"),C.appendChild(a)});const n=document.createElement("div");n.className="dropdown-item new-category-btn",n.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Create New Category
        `,C.appendChild(n)}C&&C.addEventListener("click",t=>{const n=t.target.closest(".dropdown-item");if(n){if(n.classList.contains("new-category-btn"))pe.textContent="New Category",P=null,U.classList.remove("hidden"),U.focus();else{const o=n.dataset.categoryId,a=n.textContent;C.querySelectorAll(".dropdown-item").forEach(l=>l.classList.remove("selected")),n.classList.add("selected"),pe.textContent=a,P=o,U.classList.add("hidden")}X.classList.remove("open"),C.classList.add("hidden")}}),de&&de.addEventListener("click",()=>{const t=document.getElementById("contrib-username").value.trim()||"Anonymous",n=document.getElementById("contrib-term-name").value.trim(),o=document.getElementById("contrib-definition").value.trim(),a=document.getElementById("contrib-examples").value.trim(),l=K.querySelector(".pill.active"),c=l?l.dataset.value:"beginner";if(!n||!o){showToast("Fields Required","Please fill in both the term name and its definition.","warning");return}const m=a?a.split(",").map(u=>u.trim()):[];if(me&&J){const u={name:n,definition:o,difficulty:c,examples:m,author:t.replace("@","")};b.editTerm(J,me,u)&&(B===J&&Z(J),Q(),D.classList.add("hidden"))}else{let u;if(!P&&!U.classList.contains("hidden")){const h=U.value.trim();if(!h){showToast("Category Name Required","Please enter a name for the new category.","warning");return}u="user_"+h.toLowerCase().replace(/\s+/g,"_"),b.addCategory({id:u,name:h,author:t,terms:[]}),ye(),we()}else if(P)u=P;else{showToast("Category Selection Required","Please select a category from the dropdown.","warning");return}const f={id:"user_"+Date.now(),name:n,definition:o,difficulty:c,examples:m,author:t.replace("@",""),likes:0};b.addTerm(u,f),B===u&&Z(u),Q(),D.classList.add("hidden")}});function Q(){me=null,J=null,document.querySelector(".modal-header h3").textContent="Contribute a Term",de.textContent="Submit Term",document.getElementById("contrib-username").value="",document.getElementById("contrib-term-name").value="",document.getElementById("contrib-definition").value="",document.getElementById("contrib-examples").value="",U.value="",U.classList.add("hidden"),P=null,pe.textContent="Select a category",K.querySelectorAll(".pill").forEach(t=>t.classList.remove("active"))}He&&He.addEventListener("click",()=>{Q(),D.classList.add("hidden")}),je&&je.addEventListener("click",()=>{Q(),D.classList.add("hidden")});function be(){if(!dt)return;const t=S.getConfiguredProviders();Ge.forEach(a=>{const l=a.dataset.provider,c=a.querySelector(".provider-setup-status"),m=a.querySelector(".setup-key-btn");t.includes(l)?(c.textContent="CONFIGURED",c.classList.add("configured"),m.textContent="Update Key"):(c.textContent="NOT CONFIGURED",c.classList.remove("configured"),m.textContent="Setup API Key")}),Oe&&(Oe.style.display=t.length>0?"flex":"none");const n=S.getUsageStats(),o=Object.keys(n).length>0;if(j==null||j.classList.toggle("hidden",!o),o&&j){const a=j.querySelector(".usage-stats-grid"),l=j.querySelector(".usage-total-tokens");a.innerHTML="";let c=0;for(const[m,u]of Object.entries(n)){c+=u.requestCount;const f=u.lastUsed?new Date(u.lastUsed).toLocaleDateString():"Never",h=document.createElement("div");h.className="stat-box",h.innerHTML=`
                    <div class="stat-header">
                        <div class="stat-provider">${S.providers[m].name}</div>
                        <div class="stat-indicator"></div>
                    </div>
                    <div class="stat-main">
                        <div class="stat-value">${u.requestCount}<span class="stat-unit">Requests</span></div>
                    </div>
                    <div class="stat-footer">
                        <div class="stat-info">
                            <span>Active Model</span>
                            <span>${u.model||"Default"}</span>
                        </div>
                        <div class="stat-info">
                            <span>Last Used</span>
                            <span>${f}</span>
                        </div>
                    </div>
                `,a.appendChild(h)}l&&(l.textContent=`Total Requests: ${c}`)}}function vt(t){ce=t;const n=S.providers[t];document.getElementById("modal-provider-name").textContent=`Configure ${n.name}`,fe.value=S.getProviderKey(t)||"";const o=document.querySelector("#llm-provider-dropdown .dropdown-value");o&&(o.textContent=n.name),document.querySelectorAll("#llm-provider-dropdown .dropdown-item").forEach(c=>{c.classList.toggle("selected",c.dataset.providerId===t)}),G.classList.add("hidden"),G.classList.remove("success","error");const a=document.getElementById("provider-api-key");a.type="password";const l=document.getElementById("toggle-api-key");l&&(l.querySelector(".eye-icon").classList.remove("hidden"),l.querySelector(".eye-off-icon").classList.add("hidden")),document.getElementById("custom-model-group").classList.add("hidden"),document.getElementById("custom-model-id").value="",Ke(t),le.classList.remove("hidden")}function Ke(t){const n=document.getElementById("model-dropdown-menu"),o=document.querySelector("#llm-model-dropdown .dropdown-value"),a=document.getElementById("custom-model-group"),l=document.getElementById("custom-model-id"),c=S.providers[t],m=S.config[t],u=(m==null?void 0:m.model)||c.models[0].id,f=c.models.some(y=>y.id===u);n.innerHTML="",c.models.forEach(y=>{const L=document.createElement("div");L.className="dropdown-item",y.id===u&&(L.classList.add("selected"),o.textContent=y.name,F=y.id),L.textContent=y.name,L.dataset.modelId=y.id,L.addEventListener("click",()=>{n.querySelectorAll(".dropdown-item").forEach(O=>O.classList.remove("selected")),L.classList.add("selected"),o.textContent=y.name,F=y.id,a.classList.add("hidden"),document.getElementById("model-dropdown-menu").classList.add("hidden"),document.getElementById("llm-model-dropdown").classList.remove("open")}),n.appendChild(L)});const h=document.createElement("div");h.className="dropdown-item",h.textContent="Custom Model",h.dataset.modelId="custom",f||(h.classList.add("selected"),o.textContent="Custom Model",F="custom",a.classList.remove("hidden"),l.value=u),h.addEventListener("click",()=>{n.querySelectorAll(".dropdown-item").forEach(y=>y.classList.remove("selected")),h.classList.add("selected"),o.textContent="Custom Model",F="custom",a.classList.remove("hidden"),l.focus(),document.getElementById("model-dropdown-menu").classList.add("hidden"),document.getElementById("llm-model-dropdown").classList.remove("open")}),n.appendChild(h)}Ge.forEach(t=>{t.querySelector(".setup-key-btn").addEventListener("click",()=>{vt(t.dataset.provider)})}),Re&&Re.addEventListener("click",()=>le.classList.add("hidden")),$e&&$e.addEventListener("click",()=>le.classList.add("hidden")),Me&&Me.addEventListener("click",async()=>{const t=fe.value.trim();let n=F;if(!t){showToast("Input Required","Please enter an API key","warning");return}if(F==="custom"){const a=document.getElementById("custom-model-id").value.trim();if(!a){showToast("Input Required","Please enter a custom model ID","warning");return}n=a}G.classList.remove("hidden"),G.innerHTML='<div class="loader-small"></div><span>Validating key...</span>';const o=await S.validateKey(ce,t);G.innerHTML=`<span>${o.message}</span>`,G.classList.replace("hidden",o.valid?"success":"error"),o.valid||G.classList.add("error"),o.valid&&(await S.setProviderKey(ce,t,n),setTimeout(()=>{le.classList.add("hidden"),be()},1e3))});const Ee=[{triggerId:"provider-dropdown-trigger",menuId:"provider-dropdown-menu",wrapperId:"llm-provider-dropdown"},{triggerId:"model-dropdown-trigger",menuId:"model-dropdown-menu",wrapperId:"llm-model-dropdown"}];Ee.forEach(t=>{const n=document.getElementById(t.triggerId);n&&n.addEventListener("click",o=>{o.stopPropagation(),Ee.forEach(a=>{if(a.triggerId!==t.triggerId){const l=document.getElementById(a.menuId),c=document.getElementById(a.wrapperId);l&&l.classList.add("hidden"),c&&c.classList.remove("open")}}),document.getElementById(t.wrapperId).classList.toggle("open"),document.getElementById(t.menuId).classList.toggle("hidden")})}),document.querySelectorAll("#llm-provider-dropdown .dropdown-item").forEach(t=>{t.addEventListener("click",()=>{const n=t.dataset.providerId,o=t.textContent;document.querySelector("#llm-provider-dropdown .dropdown-value").textContent=o,document.querySelectorAll("#llm-provider-dropdown .dropdown-item").forEach(a=>a.classList.remove("selected")),t.classList.add("selected"),ce=n,fe.value=S.getProviderKey(n)||"",Ke(n),document.getElementById("provider-dropdown-menu").classList.add("hidden"),document.getElementById("llm-provider-dropdown").classList.remove("open")})}),document.addEventListener("click",()=>{Ee.forEach(t=>{const n=document.getElementById(t.menuId),o=document.getElementById(t.wrapperId);n&&n.classList.add("hidden"),o&&o.classList.remove("open")})}),window.showToast=function(t,n,o="info",a=5e3){const l=document.getElementById("toast-container");if(!l)return;const c=document.createElement("div");c.className=`toast ${o}`;const m=o==="success"?'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>':'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';c.innerHTML=`
            <div class="toast-icon">${m}</div>
            <div class="toast-content">
                <div class="toast-title">${t}</div>
                <div class="toast-message">${n}</div>
            </div>
        `,l.appendChild(c),setTimeout(()=>{c.classList.add("hiding"),setTimeout(()=>c.remove(),300)},a)};const q=new Map;function Le(t,n,o=!1){if(!q.has(t)||o)q.set(t,{stack:[n],index:0});else{const a=q.get(t);a.index<a.stack.length-1&&(a.stack=a.stack.slice(0,a.index+1)),n!==a.stack[a.index]&&(a.stack.push(n),a.index++)}ge(t)}function ge(t){const n=q.get(t);if(!n)return;const o=t.querySelector(".scene-undo-btn"),a=t.querySelector(".scene-redo-btn");o&&o.classList.toggle("hidden",n.index<=0),a&&a.classList.toggle("hidden",n.index>=n.stack.length-1)}v.addEventListener("input",t=>{if(t.target.classList.contains("scene-description")){const n=t.target.closest(".scene-item"),o=q.get(n);o?(o.stack[o.index]=t.target.value,o.index<o.stack.length-1&&(o.stack=o.stack.slice(0,o.index+1)),ge(n)):Le(n,t.target.value,!0)}}),v&&v.addEventListener("click",async t=>{const n=t.target.closest(".scene-undo-btn");if(n){const f=n.closest(".scene-item"),h=q.get(f);if(h&&h.index>0){h.index--;const y=f.querySelector(".scene-description");y.value=h.stack[h.index],ge(f),showToast("Undo","Reverted to previous version","info")}return}const o=t.target.closest(".scene-redo-btn");if(o){const f=o.closest(".scene-item"),h=q.get(f);if(h&&h.index<h.stack.length-1){h.index++;const y=f.querySelector(".scene-description");y.value=h.stack[h.index],ge(f),showToast("Redo","Restored next version","info")}return}const a=t.target.closest(".scene-enhance-btn");if(!a)return;const l=a.closest(".scene-item");if(!l)return;const c=l.querySelector(".scene-description"),m=S.getConfiguredProviders();if(m.length===0){showToast("Configuration Required","Please configure an AI provider in the integration hub first.","warning");return}const u=m[0];a.classList.add("loading"),a.disabled=!0;try{const f=c.value.trim(),h=l.querySelector(".scene-camera-value").value,y=l.querySelector(".scene-lighting-value").value,L=l.querySelector(".scene-negative-prompt").value.trim();if(!f){showToast("Description Required","Please describe the scene before enhancing.","warning");return}q.has(l)||Le(l,f,!0);const O={description:f,camera:h||"",lighting:y||"",negative_prompt:L||""},Y=k.getParams().platform_preset,Se=k.modelService.getProfile(Y),ot=await S.generatePrompt(u,O,{modelProfile:Se});c.value=ot,Le(l,ot),showToast("Scene Enhanced","AI version added to history stack!","success")}catch(f){console.error("Enhance Error:",f);let h="AI Enhancement Failed",y=f.message;(f.message.toLowerCase().includes("quota")||f.message.toLowerCase().includes("rate limit"))&&(h="Quota Exceeded",y="Wait a moment or switch to Gemini 1.5 Flash."),showToast(h,y,"error")}finally{a.classList.remove("loading"),a.disabled=!1}});const A=document.getElementById("history-modal"),Je=document.getElementById("history-list"),ee=document.getElementById("history-preview-code"),te=document.getElementById("history-preview-actions"),Ve=document.getElementById("history-section-list"),ne=document.getElementById("history-section-preview-code"),se=document.getElementById("history-section-preview-actions");let V=null;(Xe=document.getElementById("history-trigger-btn"))==null||Xe.addEventListener("click",()=>{N("modal"),A==null||A.classList.remove("hidden")}),(Qe=document.getElementById("history-close-btn"))==null||Qe.addEventListener("click",()=>{A==null||A.classList.add("hidden")});const Ye=()=>{confirm("Are you sure you want to clear all history?")&&(R.clear(),N("modal"),N("section"),ee&&(ee.textContent="History cleared."),ne&&(ne.textContent="History cleared."),te&&te.classList.add("hidden"),se&&se.classList.add("hidden"),showToast("History Cleared","All recorded versions have been removed.","info"))};(et=document.getElementById("history-clear-btn"))==null||et.addEventListener("click",Ye),(tt=document.getElementById("history-section-clear-btn"))==null||tt.addEventListener("click",Ye);const ze=()=>{if(V){s.value=JSON.stringify(V.content,null,2),A==null||A.classList.add("hidden");const t=document.querySelector(".main-nav a.active");if((t==null?void 0:t.textContent.trim())==="History"){const n=Array.from(document.querySelectorAll(".main-nav a")).find(o=>o.textContent.trim()==="JSON Generator");n==null||n.click()}document.getElementById("output-section").classList.remove("hidden"),document.getElementById("output-section").scrollIntoView({behavior:"smooth",block:"start"}),showToast("Restored","Version loaded into output editor.","success")}};(nt=document.getElementById("history-restore-btn"))==null||nt.addEventListener("click",ze),(st=document.getElementById("history-section-restore-btn"))==null||st.addEventListener("click",ze);function N(t){const n=R.getAll(),o=t==="modal"?Je:Ve;if(o){if(o.innerHTML="",n.length===0){o.innerHTML='<div class="empty-state" style="padding: 20px; font-size: 0.85rem;">No history found.</div>';return}n.forEach(a=>{const l=document.createElement("div");l.className="history-item",l.dataset.id=a.id;const c=new Date(a.timestamp),m=c.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),u=c.toLocaleDateString(),f=a.mode==="ai"?"badge-ai":"badge-json",h=a.mode==="ai"?"AI":"JSON";l.innerHTML=`
                <div class="history-item-top">
                    <div class="history-summary">${a.summary||"Generated Prompt"}</div>
                    <span class="history-badge ${f}">${h}</span>
                </div>
                <div class="history-item-bottom">
                    <div class="history-date">${u} ${m}</div>
                    <button class="history-delete-btn" title="Delete Version">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
            `,l.querySelector(".history-delete-btn").addEventListener("click",L=>{L.stopPropagation(),confirm("Delete this version history?")&&(R.delete(a.id),N("modal"),N("section"),V&&V.id===a.id&&(V=null,te&&te.classList.add("hidden"),se&&se.classList.add("hidden"),ee&&(ee.innerHTML='<div class="placeholder-content">Select an item from the sidebar...</div>'),ne&&(ne.innerHTML='<div class="placeholder-content">Select an item from the sidebar...</div>')))}),l.addEventListener("click",()=>yt(a,l,t)),o.appendChild(l)})}}function yt(t,n,o){const a=o==="modal"?Je:Ve;a==null||a.querySelectorAll(".history-item").forEach(m=>m.classList.remove("active")),n.classList.add("active"),V=t;const l=o==="modal"?ee:ne,c=o==="modal"?te:se;c&&c.classList.remove("hidden"),l&&(l.textContent=JSON.stringify(t.content,null,2))}window.renderHistoryView=N;const We=document.getElementById("save-as-template"),Ze=document.getElementById("open-template-gallery");We&&We.addEventListener("click",()=>{const t=[];v.querySelectorAll(".scene-item").forEach(a=>{const l=a.querySelector(".scene-description").value,c=a.querySelector(".scene-camera-value").value,m=a.querySelector(".scene-lighting-value").value,u=Array.from(a.querySelectorAll(".negative-pills .pill.active")).map(h=>h.dataset.value),f=a.querySelector(".scene-negative-prompt").value;t.push({description:l,camera:c,lighting:m,negativePills:u,customNegative:f})});const o={scenes:t,globalParams:k.getParams()};window.templateUI?window.templateUI.openSaveModal(o):console.error("TemplateUI not found")}),Ze&&Ze.addEventListener("click",()=>{window.templateUI&&window.templateUI.openGallery()}),window.addEventListener("apply-template",t=>{const n=t.detail;!n||!n.scenes||confirm("Apply this template? Current scenes will be replaced.")&&(v.querySelectorAll(".scene-item").forEach(a=>a.remove()),z=0,n.scenes.forEach(a=>{e.click();const l=v.lastElementChild;if(l&&(l.querySelector(".scene-description").value=a.description||"",a.camera&&(l.querySelector(".scene-camera-value").value=a.camera,l.querySelectorAll(".camera-pills .pill").forEach(m=>{m.dataset.value===a.camera&&m.classList.add("active")})),a.lighting&&(l.querySelector(".scene-lighting-value").value=a.lighting,l.querySelectorAll(".lighting-pills .pill").forEach(m=>{m.dataset.value===a.lighting&&m.classList.add("active")})),l.querySelector(".scene-negative-prompt").value=a.customNegative||"",a.negativePills&&Array.isArray(a.negativePills))){const c=l.querySelector(".negative-pills");c&&c.querySelectorAll(".pill").forEach(u=>{a.negativePills.includes(u.dataset.value)&&u.classList.add("active")})}}),n.globalParams&&(["aspect_ratio","resolution","frame_rate","platform_preset"].forEach(a=>{n.globalParams[a]&&k.updateParam(a,n.globalParams[a])}),ae()),showToast("Template Applied","Configuration loaded successfully.","success"))})});
